<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Schema Validator</title>
    <p>Using ajax/libs/ajv/6.12.6</p>
    <p>Validate all embedded schemas within the JSON file</p>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.6/ajv.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #file-input { display: none; }
        #upload-label {
            display: block; width: 100%; padding: 20px; text-align: center;
            border: 2px dashed #aaa; cursor: pointer; margin: 20px 0; background-color: #f9f9f9;
        }
        #upload-label:hover { background-color: #e6e6e6; }
        #result { margin-top: 20px; }
        .valid-schema { color: green; }
        .invalid-schema { color: red; }
    </style>
</head>

<body>
    <h1>JSON Schema Validator</h1>
    <label for="file-input" id="upload-label">Tap to select a JSON file</label>
    <input type="file" id="file-input" accept="application/json">
    <h2>Validation Results</h2>
    <ul id="result"></ul>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const fileInput = document.getElementById("file-input");
            const resultList = document.getElementById("result");

            fileInput.addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (!file || file.type !== "application/json") {
                    resultList.innerHTML = `<li class="invalid-schema">❌ Please select a valid JSON file</li>`;
                    return;
                }

                try {
                    const jsonData = JSON.parse(await file.text());
                    console.log("Loaded JSON:", jsonData);

                    if (!jsonData["$schema"]) {
                        resultList.innerHTML = `<li class="invalid-schema">❌ No "$schema" field found in JSON.</li>`;
                        return;
                    }

                    const schemaURL = jsonData["$schema"];
                    console.log("Fetching schema from:", schemaURL);

                    const schemaResponse = await fetch(schemaURL);
                    if (!schemaResponse.ok) {
                        resultList.innerHTML = `<li class="invalid-schema">❌ Failed to load schema from ${schemaURL}</li>`;
                        return;
                    }

                    const schema = await schemaResponse.json();
                    console.log("Loaded Schema:", schema);

                    validateJSON(jsonData, schema);
                } catch (error) {
                    console.error("Parsing error:", error);
                    resultList.innerHTML = `<li class="invalid-schema">❌ Invalid JSON file (Parsing error)</li>`;
                }
            });

            function validateJSON(data, schema) {
                resultList.innerHTML = "";
                console.log("Validating JSON...");

                const ajv = new Ajv({ allErrors: true });
                const validate = ajv.compile(schema);
                const valid = validate(data);

                if (valid) {
                    resultList.innerHTML = `<li class="valid-schema">✅ JSON is valid against the schema.</li>`;
                } else {
                    console.error("Validation errors:", ajv.errorsText(validate.errors));
                    resultList.innerHTML = `<li class="invalid-schema">❌ JSON validation failed: ${ajv.errorsText(validate.errors)}</li>`;
                }
            }
        });
    </script>
</body>
</html>
