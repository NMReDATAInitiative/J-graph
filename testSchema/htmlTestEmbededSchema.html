<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Schema Validator</title>
    <p>Using ajax/libs/ajv/6.12.6</p>
    <p>Validate all embedded schemas within the JSON file</p>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.6/ajv.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #file-input { display: none; }
        #upload-label {
            display: block; width: 100%; padding: 20px; text-align: center;
            border: 2px dashed #aaa; cursor: pointer; margin: 20px 0; background-color: #f9f9f9;
        }
        #upload-label:hover { background-color: #e6e6e6; }
        #result { margin-top: 20px; }
        .valid-schema { color: green; }
        .invalid-schema { color: red; }
    </style>
</head>

<body>
    <h1>JSON Schema Validator</h1>
    <label for="file-input" id="upload-label">Tap to select a JSON file</label>
    <input type="file" id="file-input" accept="application/json">
    <h2>Validation Results</h2>
    <ul id="result"></ul>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const fileInput = document.getElementById("file-input");
            const resultList = document.getElementById("result");

            console.log("Initializing schema validator...");
            const schemas = await fetchSchemas();

            fileInput.addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (!file || file.type !== "application/json") {
                    resultList.innerHTML = `<li class="invalid-schema">‚ùå Please select a valid JSON file</li>`;
                    return;
                }

                try {
                    const jsonData = JSON.parse(await file.text());
                    console.log("Loaded JSON:", jsonData);
                    validateJSON(jsonData, schemas);
                } catch (error) {
                    console.error("Parsing error:", error);
                    resultList.innerHTML = `<li class="invalid-schema">‚ùå Invalid JSON file (Parsing error)</li>`;
                }
            });

            async function fetchSchemas() {
                try {
                    console.log("Fetching schema index...");
                    const response = await fetch("./index.json");
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                    const schemaList = await response.json();
                    console.log("Schema index loaded:", schemaList);

                    const schemaObjects = {};
                    for (let schemaName of schemaList) {
                        let schemaPath = `./${schemaName}`;
                        let schemaResponse = await fetch(schemaPath);
                        if (!schemaResponse.ok) {
                            console.error(`Error fetching schema ${schemaName}: ${schemaResponse.statusText}`);
                            continue;
                        }
                        const schemaData = await schemaResponse.json();
                        schemaObjects[schemaName] = schemaData;

                        // Store schema under its ID if available
                        if (schemaData["$id"]) {
                            schemaObjects[schemaData["$id"]] = schemaData;
                        }

                        console.log(`‚úÖ Loaded schema: ${schemaName}`);
                    }

                    return schemaObjects;
                } catch (error) {
                    console.error("Error loading schemas:", error);
                    return {};
                }
            }

            function resolveReferences(schema, schemas) {
                if (!schema || typeof schema !== "object") return schema;

                if (schema.$ref) {
                    let ref = schema.$ref;
                    if (schemas[ref]) {
                        console.log(`üîó Resolving $ref: ${ref}`);
                        return resolveReferences(schemas[ref], schemas);
                    } else {
                        console.error(`‚ùå Reference not found: ${ref}`);
                        return null;
                    }
                }

                if (schema.properties) {
                    for (const key in schema.properties) {
                        schema.properties[key] = resolveReferences(schema.properties[key], schemas);
                    }
                }
                if (schema.items) {
                    schema.items = resolveReferences(schema.items, schemas);
                }

                return schema;
            }

       function validateJSON(data, schemas) {
    resultList.innerHTML = "";
    console.log("Validating JSON...", data);

    const ajv = new Ajv({ allErrors: true });

    // Add schemas to Ajv **only if they haven't been added before**
    const addedSchemas = new Set();
    Object.keys(schemas).forEach((schemaName) => {
        if (!addedSchemas.has(schemaName)) {
            try {
                ajv.addSchema(schemas[schemaName], schemaName);
                addedSchemas.add(schemaName);
            } catch (error) {
                console.warn(`‚ö†Ô∏è Skipping duplicate schema: ${schemaName}`);
            }
        }
    });

    const validationResults = findSchemasAndValidate(data, ajv, schemas);
    if (validationResults.length === 0) {
        resultList.innerHTML = `<li class="invalid-schema">‚ùå No "$schema" fields found in JSON.</li>`;
    } else {
        resultList.innerHTML = validationResults.join("");
    }
}

function findSchemasAndValidate(json, ajv, schemas, path = "") {
    let results = [];

    function recursiveSearch(obj, currentPath) {
        if (typeof obj !== "object" || obj === null) return;

        if (obj["$schema"]) {
            let schemaName = obj["$schema"];
            let location = currentPath || "Root";

            if (!(schemaName in schemas)) {
                console.error(`‚ùå Schema "${schemaName}" not found for ${location}`);
                results.push(`<li class="invalid-schema">‚ùå Schema "${schemaName}" not found for ${location}</li>`);
                return;
            }

            const validate = ajv.getSchema(schemaName);
            if (!validate) {
                console.error(`‚ùå Could not retrieve compiled schema: ${schemaName}`);
                results.push(`<li class="invalid-schema">‚ùå Could not retrieve compiled schema: ${schemaName}</li>`);
                return;
            }

            const valid = validate(obj);
            if (valid) {
                console.log(`‚úÖ ${location} - Valid against ${schemaName}`);
                results.push(`<li class="valid-schema">‚úÖ ${location} - Valid against ${schemaName}</li>`);
            } else {
                console.error(`‚ùå ${location} - Invalid against ${schemaName}: ${ajv.errorsText(validate.errors)}`);
                results.push(`<li class="invalid-schema">‚ùå ${location} - Invalid against ${schemaName}: ${ajv.errorsText(validate.errors)}</li>`);
            }
        }

        for (let key in obj) {
            if (typeof obj[key] === "object") {
                recursiveSearch(obj[key], `${currentPath}/${key}`);
            }
        }
    }

    recursiveSearch(json, path);
    return results;
}

        });
    </script>
</body>
</html>