<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema: obj1.json</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { padding: 10px; border: 1px solid black; text-align: left; }
        th { background-color: #f2f2f2; }
        textarea { width: 100%; height: 200px; font-family: monospace; }
        #validationMessage { font-weight: bold; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.12.0/ajv.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv-formats/2.1.1/ajv-formats.min.js"></script>
</head>
<body>
    <h1>Schema: obj1.json</h1>
    <p><strong>Schema ID:</strong> <a href="https://raw.githubusercontent.com/NMReDATAInitiative/J-graph/main/testSchema/schemaNoLinkData/obj1.json" target="_blank">obj1.json</a></p>
    
    <h2>Properties</h2>
    <table border="1">
        <tr>
            <th>Property</th>
            <th>Type</th>
            <th>Schema Reference</th>
            <th>Required</th>
        </tr>
        <tr><td>name</td><td>string</td><td>-</td><td>✅ Yes</td></tr>
        <tr><td>age</td><td>integer</td><td>-</td><td>❌ No</td></tr>
    </table>

    <h2>Load JSON Instance</h2>
    <select id="instanceSelector">
        <option value="">Select an instance...</option>
        <option value="alice.json">alice.json</option>
        <option value="testEmbeddedSchema.json">testEmbeddedSchema.json</option>
    </select>

    <h2>Edit JSON Instance</h2>
    <textarea id="jsonEditor"></textarea>
    <p id="validationMessage"></p>
    <p><a href="index.html">Back to Index</a></p>

    <script>
document.addEventListener("DOMContentLoaded", async function () {
    const editor = document.getElementById("jsonEditor");
    const selector = document.getElementById("instanceSelector");
    const validationMessage = document.getElementById("validationMessage");

    // ✅ Ensure the text box is cleared when the page loads
    if (editor) {
        editor.value = "";
    } else {
        console.error("❌ Error: jsonEditor element not found!");
    }

    // ✅ Attach event listener to dropdown
    if (selector) {
        selector.addEventListener("change", function () {
            loadInstance(selector.value);
        });
    } else {
        console.warn("⚠️ No instance selector found.");
    }

    // ✅ Ensure AJV is loaded before validation
    await loadAjv();
});

async function loadAjv() {
    if (typeof window.Ajv === "undefined") {
        console.log("⏳ Loading AJV...");
        await new Promise((resolve) => {
            const script = document.createElement("script");
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/ajv/8.12.0/ajv.min.js";
            script.onload = resolve;
            document.head.appendChild(script);
        });

        await new Promise((resolve) => {
            const script = document.createElement("script");
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/ajv-formats/2.1.1/ajv-formats.min.js";
            script.onload = resolve;
            document.head.appendChild(script);
        });

        console.log("✅ AJV loaded successfully.");
    }
}

/** ✅ Function to Load JSON Instance */
function loadInstance(fileName) {
    if (!fileName) return; 

    console.log("Loading instance:", fileName);

    fetch("../instances/" + fileName)
        .then(response => {
            if (!response.ok) throw new Error("Failed to fetch instance: " + response.status);
            return response.json();
        })
        .then(data => {
            document.getElementById("jsonEditor").value = JSON.stringify(data, null, 4);
            validateJson();
        })
        .catch(err => {
            console.error("Error loading instance:", err);
            document.getElementById("jsonEditor").value = "";
            document.getElementById("validationMessage").textContent = "❌ Failed to load instance: " + err.message;
        });
}

/** ✅ Function to Fetch Schema */
async function fetchSchema(url) {
    console.log(`⏳ Fetching schema: ${url}`);
    let response = await fetch(url);
    if (!response.ok) throw new Error(`❌ Failed to fetch schema: ${url}`);
    return response.json();
}

/** ✅ Function to Resolve `$ref` References */
async function resolveRefs(schema, schemas = {}) {
    if (!schema || typeof schema !== "object") return;

    for (let key in schema) {
        if (key === "$ref" && typeof schema[key] === "string") {
            let refUrl = schema[key];
            if (!schemas[refUrl]) {
                schemas[refUrl] = await fetchSchema(refUrl);
                await resolveRefs(schemas[refUrl], schemas);
            }
        } else if (typeof schema[key] === "object") {
            await resolveRefs(schema[key], schemas);
        }
    }
}

/** ✅ Function to Validate JSON */
async function validateJson() {
    const text = document.getElementById("jsonEditor").value;
    let validationMessage = document.getElementById("validationMessage");

    try {
        console.log("Validation running...");
        if (!text.trim()) throw new Error("Empty JSON input.");

        const jsonData = JSON.parse(text);
        const schemaUrl = jsonData["$schema"];
        if (!schemaUrl) throw new Error("No $schema found in JSON.");

        // ✅ Wait for AJV to load
        await loadAjv();

        // ✅ Fetch schema and resolve references
        let schemas = {};
        schemas[schemaUrl] = await fetchSchema(schemaUrl);
        await resolveRefs(schemas[schemaUrl], schemas);

        // ✅ Ensure AJV is available
        if (typeof window.Ajv === "undefined") {
            throw new Error("AJV is still not defined after loading.");
        }

        // ✅ Initialize AJV and validate
        const ajv = new window.Ajv({ allErrors: true, schemas });
        window.addFormats(ajv);
        const validate = ajv.compile(schemas[schemaUrl]);

        if (validate(jsonData)) {
            validationMessage.style.color = "green";
            validationMessage.textContent = "✅ Valid JSON";
        } else {
            validationMessage.style.color = "red";
            validationMessage.innerHTML = "❌ Invalid JSON:<br>" + JSON.stringify(validate.errors, null, 4);
        }
    } catch (error) {
        validationMessage.style.color = "red";
        validationMessage.textContent = "❌ Validation Error: " + error.message;
        console.error("Validation Error:", error);
    }
}
</script>

</body>
</html>
